---
title: "DATA3888 COVID Report"
author: '500254239'
date: "`r format(Sys.time(), '%d %b %Y')`"
output: 
  bookdown::html_document2:
    theme: 
      # bootswatch: lumen
      sandstone
    code_folding: hide
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
bibliography: [references.bib, references-pkg.bib]
csl: apa-6th-edition.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,    # for final report, set to FALSE to hide all code chunks
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.cap = ""
)
```

```{r libraries}
library(tidyverse)
library(kableExtra)
library(DT)
library(tidyr)
library(dplyr)
library(ggplot2)
library(plotly)

library(readxl)
library(tibble)
library(ggthemes)

library(plotly) # Interactive data visualizations
library(viridis) # Color gradients
library(lubridate)
library(qtlcharts) # Interactive scatter plots 

library(randomForest) 
library(ranger)       # a faster implementation of randomForest
library(caret)        # performe many machine learning models
library(broom)  # try: `install.packages("backports")` if diretly installing broom gives an error

library(reshape2) # to use melt()

library(deSolve)
library(permimp) # for calculating conditional importance in a speedy way



```

# Guide for RMarkdown report (remove for final report)

## Bibliographies in RMarkdown

- `references.bib`: for BibTeX of all sources you wish to reference
- `references-pkg.bib`: for BibTeX of all packages used in the report

Bibliographies will be included automatically at the end before appendix. Copy paste `bib` or `BibTeX` text from your sources into the file `references.bib` following the example format, leaving an empty line between entries. Name it however you want in the first line after `@document-format{` like in the example. For any package you are using, if there isn't already an entry for it in the bib file, then use the function `citation("package-name")` in R console and copy the `BibTeX` entry from the output, paste it into `references-pkg.bib`.

Examples of how to reference bib entries in-text (check the rmd file):

- Garth reference: [@RN83]
- `tidyverse` reference: [@tidyverse]

## Sections cross-referencing

You can cross-reference to sections, so that the link point to the relevant heading (check the rmd file):

- use `{#section-id}` after heading to label the section followed, where `section-id` is user-defined and acts as the identifier of the section
- use `\@ref(section-id)` or `\@ref(section-heading)` if there is no identifier, to refer to the section you want to link to

Examples (check rmd file):

- this text refers to the appendix A with the heading "Code" (Appendix \@ref(code))
- this text refers to the section labelled with *id* `vri` (Section \@ref(vri))
- this text refers to the section "Data Background" (Section \@ref(data-background))

*Note this will only show the number of the section, you have to put "Section"/"Appendix" before the `\@ref(...)` as well.*

## Figures/Tables cross-referencing

- use `\@ref(fig:chunk-name)` to refer to figure output by the chunk named as `chunk-name`
- use `\@ref(tab:chunk-name)` to refer to the table output by the chunk named as `chunk-name`

Here is an example plot with caption and its in-text reference (check rmd file):

- Figure \@ref(fig:example-plot). 

*Note this will only show the number (default format: section-num.figure-num), you have to put "Figure" before the `\@ref(fig:..)` as well.*

```{r example-plot, fig.cap="Example plot"}
# example plot
mtcars %>% 
  rownames_to_column("car") %>% 
  as_tibble() %>% 
  ggplot() +
  aes(x = factor(cyl), y = disp, colour = factor(cyl)) +
  geom_boxplot()
```

Here is an example table with caption and its in-text reference:

- Table \@ref(tab:example-table)

*Note this will only show the number (default format: section-num.table-num), you have to put "Table" before the `\@ref(tab:..)` as well.*

```{r example-table}
# example table
mtcars %>% 
  kbl(caption = "Example table",
      format = "html",
      booktabs = TRUE,
      row.names = TRUE,
      escape = TRUE) %>%
  kable_styling(bootstrap_options = c("condensed", "striped", "hover"),
                position = "center") %>%
  scroll_box(height = "300px")
```


# Executive Summary



# Data Background

```{r data-loadin}
covid_data = read.csv("data/covid_data_latest.csv")
covid_data$date = ymd(covid_data$date)

policy = read.csv("data/covid-vaccination-policy.csv")
policy$Day = ymd(policy$Day)

policy$vaccination_policy = as.factor(policy$vaccination_policy)
happiness = read.csv("data/happiness-cantril-ladder.csv")
ghs = read.csv("data/2021-GHS-Index-April-2022.csv")
corruption = read.csv("data/CPI2020_GlobalTablesTS_210125.xlsx")
```



# Methods

## Time lag between 1st and 2nd dose {#time-lag}
```{r}
# smoother function, returns smoothed column

Lowess <- function(data, f) {
  lowess_fit <- lowess(data, f = f)
  return(lowess_fit$y)
}
lag_covid = covid_data
lag_covid = lag_covid %>%
  filter(population > 1500000) %>%
  filter(gdp_per_capita > 0)
countrys <- unique(lag_covid$location)
deleted <- c("Afghanistan", "Antigua and Barbuda", "Bangladesh","Benin", "Bhutan", "Bonaire Sint Eustatius and Saba", "Botswana", "Burundi","Burkina Faso", "Cameroon", "Cote d'Ivoire", "Democratic Republic of Congo", "Ethiopia","Eritrea", "Gabon", "Ghana", "Guernsey", "Guinea", "Kenya", "Kuwait", "Liberia", "Laos", "Namibia", "Nepal","Nicaragua", "Niger", "Nigeria", "Palestine", "Philippines", "Pitcairn", "Rwanda", "Saint Helena", "Senegal", "Sierra Leone", "Somalia", "South Sudan", "Sudan", "Tokelau", "Turkmenistan","Tanzania", "Uganda","Yemen", "World", "Zambia")
countrys = countrys[! countrys %in% deleted]
lag_covid = select(lag_covid, "date", "location", "people_vaccinated_per_hundred", "people_fully_vaccinated_per_hundred")
start_date = "2021-02-01"
end_date = "2021-08-01"
lag_covid = lag_covid %>% filter(date >= start_date & date < end_date)
lag_covid$people_vaccinated_per_hundred[is.na(lag_covid$people_vaccinated_per_hundred)] = 0
lag_covid$people_fully_vaccinated_per_hundred[is.na(lag_covid$people_fully_vaccinated_per_hundred)] = 0

lagValue <- function(FirstDose, SecondDose, windowsize, p)
{
  # vector for all measures of distance between matrices
  dist_vector = c()
  i = 1
  while (i <= windowsize){
    # select different subsets of matrices, calculate the distances between the 2 matrices and store the distance. This while loop will contain information for 1st vaccine lag
    FirstDose_subset <- FirstDose[i:nrow(FirstDose),1]
    SecondDose_subset <- SecondDose[1:(1 - i + nrow(SecondDose)),1]
    dist_FirstDose <- proxy::dist(t(FirstDose_subset), t(SecondDose_subset), method = "Minkowski", p = p)
    dist_vector = c(dist_vector, dist_FirstDose)
    i = i + 1
  }
  
  
  j = 1
  while (j <= windowsize){
    # select different subsets of matrices, calculate the distances between the 2 matrices and store the distance. This while loop will contain information for 2nd vaccine lag
    FirstDose_subset1 <- FirstDose[1:(1 - j + nrow(FirstDose)),1]
    SecondDose_subset1 <- SecondDose[j:nrow(SecondDose),1]
    dist_SecondDose <- proxy::dist(t(FirstDose_subset1), t(SecondDose_subset1), method = "Minkowski", p = p)
    dist_vector = c(dist_vector, dist_SecondDose)
    j = j + 1
  }
  
  # select min value index which corresponds to value of the lag
  return(which.min(dist_vector))
}  
```


```{r}
lag_vector_1 <- c()
lag_vector_2 <- c()
lag_vector_3 <- c()
# loop through each country and calculate 3 time lags: manhattan distance, euclidean distance and minkowski (p=3) time lags
p = 1
while (p <= 3){
  z = 1
  while (z <= length(countrys)){
    # only select records for certain country and only select 1st and 2nd vaccine columns
    lagCovid_filtered = filter(lag_covid, location == countrys[z])
    combined_matrix <- cbind(lagCovid_filtered[,3], lagCovid_filtered[,4])
    
    # In the dataset, there are missing values. Will replace these missing values (0) with the value from the date before. Do it for both 1st and 2nd vaccine columns
    
    for (i in 1:nrow(combined_matrix)){
      if (i == 1){
        } else{
        if (combined_matrix[i,1] == 0){
          combined_matrix[i,1] = combined_matrix[i-1, 1]
        }
      }
    }
    
    for (j in 1:nrow(combined_matrix)){
      if (j == 1){
        } else{
        if (combined_matrix[j,2] == 0){
          combined_matrix[j,2] = combined_matrix[j-1, 2]
        }
      }
    }
    
    # Apply smoothing function to 1st and 2nd vaccine columns. f = 0.15 is an arbitrary value
    
    combined_matrix_smooth<- as.matrix(apply(combined_matrix, 2, Lowess, f = 0.15))
    
    # Store each column separately as individual matrices
    FirstDose_matrix = as.matrix(combined_matrix_smooth[,1])
    SecondDose_matrix = as.matrix(combined_matrix_smooth[,2])
    
    # Input the individual matrices into the lagValue function to find the lag between the 1st and 2nd dose for a particular country
    lag <- lagValue(FirstDose_matrix, SecondDose_matrix, windowsize=100, p)
    
    #store value of lag
    if (p == 1){
      lag_vector_1 <- c(lag_vector_1, lag)
    } else if (p == 2){
      lag_vector_2 <- c(lag_vector_2, lag)
    } else {
      lag_vector_3 <- c(lag_vector_3, lag)
    }
    z = z + 1
  }
  p = p + 1
}
# label the lag values with the corresponding country
names(lag_vector_1) <- countrys
names(lag_vector_2) <- countrys
names(lag_vector_3) <- countrys
# function to explain the time lag value

lagType <- function(lag, windowsize)
{ # Function to convert indice value given by lagValue to a value for the Time Lag.
  # Any lag values that are greater than windowsize were part of the 2nd half of the 'dist_vector' from the lagValue function, the half of the vector for the 2nd vaccine lag.
  # Therefore need to subtract off all the days from the 1st half of the 'dist_vector' to get number of days for 2nd vaccine lag.
  # No such issue for 1st vaccine lag as all values are within first half.
  if (lag > windowsize){
    return(c(LagType = "Second Dose Lag", Lag = lag - windowsize - 1))
  } else {
    return(c(LagType = "First Dose Lag", Lag = lag - 1))
  }
}
# Apply function to each country's Time lag value 
lag_df_1 = mapply(lagType, lag = lag_vector_1, windowsize = 100)
lag_df_2 = mapply(lagType, lag = lag_vector_2, windowsize = 100)
lag_df_3 = mapply(lagType, lag = lag_vector_3, windowsize = 100)

# Visualise Time lags

total_lag = cbind(t(lag_df_1), t(lag_df_2), t(lag_df_3))
colnames(total_lag) = c("LagType", "Lag: Euclidean distance", "LagType", "Lag: Manhattan distance", "LagType", "Lag: Minkowksi distance (P=3)")
```



## Vaccine rollout index (VRI) and variable importance {#vri}

#### Exploration
```{r}
countries = c("United States", "India", "Brazil", "France", "United Kingdom", "Russia", 
              "Turkey", "Italy", "Germany", "Spain", "Argentina",
                "Iran", "Colombia", "Poland", 'Mexico', "Netherlands", 
              "Indonesia", "Ukraine", "South Africa", "Philippines", "Peru", "Belgium",
                "Czechia", "Japan", "Iran")

policy_data <- covid_data %>% 
  filter(location %in% countries)

policy <- policy %>% filter(Entity %in% countries)
policy$vaccination_policy <- as.factor(policy$vaccination_policy)

policy_data <- policy_data%>% 
  select(iso_code, continent, location, date,new_people_vaccinated_smoothed_per_hundred,  new_people_vaccinated_smoothed, new_vaccinations, new_vaccinations_smoothed, new_vaccinations_smoothed_per_million, population, people_vaccinated)

policy_data <- merge(policy_data, policy, by.x = c('iso_code', "date", "location"), by.y = c('Code', 'Day', "Entity"))
```

```{r}
get_slope <- function(country_data, country_policy, country) {
  i = 1
  country_slope <- data.frame(policy = as.factor(1:5), speed = rep(0, 5), country = rep(country, 5))
  
  while (i <= length(country_policy$vaccination_policy)) {
    current_policy = as.factor(country_policy$vaccination_policy[i])
    
    if (current_policy > 0 & !is.na(country_policy$people_vaccinated[country_policy$vaccination_policy == current_policy])) {
      temp_people <- country_data$people_vaccinated[country_data$vaccination_policy == current_policy & !is.na(country_data$people_vaccinated)] / country_data$population[1]
      
      temp_index <- 1:length(temp_people)
      
      if (length(temp_index) > 1) {
        # Linear model
        mod <- lm(temp_people ~ temp_index)
        
        # Extract and store the slope
        country_slope$speed[country_slope$policy == current_policy] <- summary(mod)$coefficients[2,1]
      } else {
        # Some countries only have a policy for 1 day -> treat the slope as 0
        country_slope$speed[country_slope$policy == current_policy] <- 0
      }
      
    } 
    
    i <- i + 1
    
  }
  
  return(country_slope)
}
```

```{r}
country_slope = NULL

for (country in countries) {
  country_data <- policy_data[policy_data$location == country, ]
  
  country_policy <- country_data[!is.na(country_data$people_vaccinated), ] %>%
    group_by(vaccination_policy) %>%
    arrange(date) %>%
    slice(1L) %>%
    select(iso_code, location, date, vaccination_policy, new_vaccinations_smoothed, population, people_vaccinated)

  temp_slope <- get_slope(country_data, country_policy, country)
  # 
  # country_slope <- rbind(country_slope, temp_slope)
}


global <- ggplot(data = country_slope, aes(x = country, y = speed, fill = as.factor(policy))) + 
  geom_bar(stat="identity", position=position_dodge()) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  scale_y_sqrt() + 
  ggtitle("All countries") + 
  xlab("Countries") + 
  ylab("Slope") + 
  labs(fill = "Avalability stage")

global
```

#### VRI


# Results

```{r}
datatable(total_lag, options = list(columnDefs = list(list(className = 'dt-center', targets = "_all"))))
```


```{r, warning = False}
# Box plots of time lags for all 3 types of time lags measurements

total_lag_df <- as.data.frame(total_lag)
colnames(total_lag_df) = c("LagType", "LagEuclideanDistance", "LagType", "LagManhattanDistance","LagType", "LagMinkowskiDistanceP3")

box <- plot_ly(type = "box")
box <- box %>% add_boxplot(x = total_lag_df$LagManhattanDistance, boxpoints = "all", jitter = 0.3, name = "Manhattan Distance")
box <- box %>% add_boxplot(x = total_lag_df$LagEuclideanDistance, boxpoints = "all", jitter = 0.3, name = "Euclidean Distance")
box <- box %>% add_boxplot(x = total_lag_df$LagMinkowskiDistanceP3, boxpoints = "all", jitter = 0.3, name = "Minkowski Distance (P=3)")
box <- box %>% layout(title = "Box Plot of Lag Between 1st and 2nd Dose")
box
```


# Discussion & Conclusion {#conclusion}


# Student Contributions


# References

::: {#refs}
:::

# (APPENDIX) Appendix {-}

# Code

```{r get-labels}
labs = knitr::all_labels()
# exclude chunk "setup" and "get-labels" (this chunk)
labs = setdiff(labs, c("setup", "get-labels"))
# can be used later if want all code in one chunk
```

```{r all-code, ref.label="example-plot", echo=TRUE, eval=FALSE}
# only example-plot code chunk
```