---
title: "Vaccination"
author: "Sylvia Liu"
date: "01/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(readxl)
library(tibble)
library(ggplot2)
library(ggthemes)
library(maps)

library(plotly) # Interactive data visualizations
library(viridis) # Color gradients
library(lubridate)
```



## Reading data
```{r}
vaccine_data <- read_csv("cumulative-covid-vaccinations.csv")
vaccine_data$Day <- as.Date(vaccine_data$Day, format = "%y-%m-%d")
#head(vaccine_data)

covid_data <- read.csv("owid-covid-data-160222.csv")
covid_data$date <- as.Date(covid_data$date, format = "%d/%m/%y")
#head(covid_data)
```

## Vaccinations progress - Vaccine Roll-Out Index (VRI) values for the countries

(Reference: https://www.mdpi.com/2076-393X/10/2/194/htm)

> **Estimate Vaccine Uptakes Rates r* for Countries**
"The logistic growth model was used to estimate the vaccination uptake rate. In the logistic model, the cumulative number of doses administered c(t) satisfies the following equation: $$c(t) = \frac{K}{1+a\cdot{e}^{-r\cdot t}}$$,"_ where K is the total vaccinations administered at the end of the date recorded, r is the vaccination uptake rate(i.e. speed), and $\frac{K}{1+a} = c(0)$ is the initial number of doses given.

```{r}
## TODO: Add a condition check or restrict the country to be passed (avoid error from missing values)
## TODO: Add constraints on argument format? Adding more conditional checks?

set.seed(3888)

### Estimate Vaccine Uptakes Rates r* for Countries
# Step 1: A function that returns the logistic model used for estimating r*

estimate_uptake_rate <- function(country) {
  
  data <- covid_data %>% filter(location == country) %>% filter(!is.na(total_vaccinations) & total_vaccinations != 0) %>% arrange(date)
  K <- data %>% select(total_vaccinations) %>% slice_tail() %>% pull()
  
  ## Calculate t by ranking the date
  data$t <- rank(data$date)
      
  ## Taking the model to get fitted
  x <- data$t-1
  y <- data$total_vaccinations
  m <- nls( y ~ (K / (1 + a*exp(-r*x))), start = list(a=0.01,r=0.01),control=nls.control(maxiter=200)) #a,r are the coefficients    
  
  return(list(model=m))
  
}

# Example
res_nls  = estimate_uptake_rate("Japan")
summary(res_nls$m)
```

**Evaluation of the metric on est.r**
```{r}
## Step2: Another function for evaluating the logistic model we created for the estimate r (r*), 
## including fitted plots, correlation values and residual values
evaluate_est_r <- function(country, m) {
  
  data <- covid_data %>% 
    filter(location == country) %>% 
    filter(!is.na(total_vaccinations) & total_vaccinations != 0) %>% 
    arrange(date) 
  
  # goodness of fit
  corr = round(cor(data$total_vaccinations, predict(m)),4)
     
  # minimized residual value
  resid = round(sum(resid(m)^2),4)
     
  # Plot fitted values vs true values
  p <- ggplot(data, aes(x = date, y = total_vaccinations)) +
  geom_point()+
  geom_line(aes(x = date, y = total_vaccinations), color="green")+
  geom_line(aes(x=date,y=predict(m)), color="blue") 
  
  return(list(plot=p,corr=corr,resid=resid))
}

# Example:
eval_res  = evaluate_est_r("Japan",res_nls$m)
eval_res$plot
paste("goodness of fit:",eval_res$corr)
paste("minimized residual value",eval_res$resid)

```

> Define and Calculate Vaccine Roll-Out Index (VRI) 
"The Vaccine Roll-out Index (VRI) for a country was defined as follows: $$VRI=r\cdot \frac{d}{N}$$," where r is the vaccination uptake rate as defined in the previous section, d is the total vaccinations, and N is the population. 

**VRI was used as an index to compare the overall vaccination progression among different countries, as it reflects both the speed and the density/extend.**

```{r}
# Step 3 calculate VRI using: est_rate * d/N
## TODO: adding constraits on argument format? Adding more conditional checks?

cal_VRI <- function(country, est_rate, spec_date) {
  
  data <- covid_data %>%  filter(location == country) %>% filter(!is.na(total_vaccinations) & total_vaccinations != 0) %>% arrange(date) %>% filter(date <= as.Date(spec_date) ) 
  d <- data %>% select(total_vaccinations) %>% slice_tail() %>% pull()
  N <- data %>% filter(!is.na(population)) %>% select(population) %>% slice_tail() %>% pull()
  VRI = est_rate * d/N
  return(vri=VRI)
  
}

```


> Comment: The function could be adjusted accordingly for the shiny app, for example:
- Changing the argument to pass in the model _m_ instead of _est. r_ value 
- Changing a single end date to a range of dates.

_Side Note: Use it in a for loop to calculate the VRI for the countries you want_
### Calculate `est.r` and `VRI` for all countries with no null values in `toal_vaccinations` column within the input date
```{r}
# Selecting countries with enough vaccination data
# Set a baseline that the country we selected should has at least 180 days(i.e. 6 months) recorded for the value of vaccinations

valid_countries_df <- covid_data %>%  
    filter(!is.na(total_vaccinations) & !is.na(population)) %>%
    group_by(iso_code,location) %>% 
    summarise(count=n())  %>% 
    filter(count >= 180 & !grepl("^OWID.", iso_code))  %>% # Remove continent and income groups
    ungroup()
    
selected_countries <- valid_countries_df$location
# selected_countries

# Calculate VRI, giving end date = "2022-02-16" (or any valid date)
results_r <- c(NA,NA) #c("Country name", est_r)
for (i in selected_countries) {
  res_model <- estimate_uptake_rate(i)$model
  results_r <- rbind(results_r,c(i,round(summary(res_model)$parameters[2],4)))
}
results_r <- results_r[-1,]
colnames(results_r) <- c("Location","Est.r")
results_r <- data.frame(results_r)
results_r$Est.r <- as.double(results_r$Est.r)
head(results_r)


results_vri <- c(NA,NA) #c("Country name", VRI)
cutoff_date = "2021-08-01"

for (i in c(1:nrow(results_r))) {
  vri = cal_VRI(results_r$Location[i],results_r$Est.r[i], cutoff_date)
  results_vri <- rbind(results_vri,c(results_r$Location[i],round(vri,4)))
}
results_vri <- results_vri[-1,]
colnames(results_vri) <- c("Location","VRI")
results_vri <- data.frame(results_vri)
results_r$VRI <- as.double(results_vri$VRI)
head(results_vri)
```


## The association between vaccination uptake rate and social-economic factors
TODO

### Selecting Covariates
TODO

### Random Forest-Based Regression Analysis of the Association between Covariates and VRI
TODO

### Evaluation Metrics
TODO